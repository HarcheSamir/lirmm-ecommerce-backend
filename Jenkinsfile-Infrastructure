// Pipeline to set up the Kubernetes cluster, Istio, and all backing infrastructure services.
// Run this once to prepare the environment.
pipeline {
    agent { label 'wsl' }

    environment {
        APP_NAMESPACE       = 'lirmm-services'
        INFRA_MANIFEST_FILE = './kind-deployment/infra-manifests.yaml'
    }

    stages {
        stage('Setup Kind Cluster and Istio') {
            steps {
                script {
                    echo "--- Running the main setup script to create the cluster and install Istio ---"
                    sh "chmod +x ./kind-deployment/setup-kind.sh"
                    sh "./kind-deployment/setup-kind.sh"
                }
            }
        }
        stage('Deploy Infrastructure Services') {
            steps {
                script {
                    echo "--- Ensuring namespace '${env.APP_NAMESPACE}' exists ---"
                    sh "kubectl create namespace ${env.APP_NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -"

                    echo "--- Applying infrastructure manifests (DBs, Kafka, etc.) ---"
                    sh "kubectl apply -f ${env.INFRA_MANIFEST_FILE} -n ${env.APP_NAMESPACE}"

                    echo "--- Waiting for all infrastructure deployments to become available ---"
                    sh "kubectl wait --for=condition=Available --all deployments -n ${env.APP_NAMESPACE} --timeout=15m"
                }
            }
        }
    }
    post {
        success {
            echo "--- INFRASTRUCTURE DEPLOYMENT SUCCEEDED ---"
            echo "The cluster is ready for the application deployment pipeline."
            echo "Access services via Istio Gateway at: http://localhost:13000"
            echo "Access Kafka externally at: localhost:29092"
            echo "Access Elasticsearch at: http://localhost:9200"
        }
    }
}
// Jenkinsfile-Infrastructure
// This pipeline sets up a fully offline installation, including Istio and its addons.
// THIS VERSION CONTAINS THE CRITICAL FIX FOR THE GROOVY SCRIPTING ERROR.
pipeline {
    agent { label 'wsl' }

    environment {
        ISTIO_BIN_DIR         = '/home/samir/istio-1.26.3/bin'
        APP_NAMESPACE         = 'lirmm-services'
        INFRA_MANIFEST_FILE   = './kind-deployment/infra-manifests.yaml'
        LOCAL_REGISTRY        = 'localhost:5001'
    }

    stages {
        stage('Push ALL Required Images to Local Registry') {
            steps {
                script {
                    def istioVersion = sh(returnStdout: true, script: "grep ISTIO_VERSION= ./kind-deployment/setup-kind.sh | cut -d '\"' -f 2").trim()
                    echo "--- Using Istio Version from script: ${istioVersion} ---"

                    def publicImages = [
                        'postgres:15-alpine',
                        'confluentinc/cp-zookeeper:7.3.2',
                        'confluentinc/cp-kafka:7.3.2',
                        'docker.elastic.co/elasticsearch/elasticsearch:8.11.1',
                        'redis:7.2-alpine',
                        "istio/pilot:${istioVersion}",
                        "istio/proxyv2:${istioVersion}",
                        'prom/prometheus:v2.53.1',
                        'jaegertracing/all-in-one:1.59',
                        'grafana/grafana:11.3.1',
                        'quay.io/kiali/kiali:v1.92',
                        'grafana/loki:3.2.1'
                    ]

                    echo "--- Pulling, re-tagging, and pushing all required images to the local registry ---"
                    publicImages.each { image ->
                        // ============================ THE FIX ===============================
                        // This robust logic replaces the previous buggy one-liner.
                        def localImage
                        if (image.startsWith("quay.io/")) {
                            // Handles quay.io/kiali/kiali -> localhost:5001/quay.io/kiali/kiali
                            localImage = "${env.LOCAL_REGISTRY}/${image}"
                        } else {
                            // Handles all other cases like prom/prometheus and istio/pilot
                            // by removing any preceding registry like docker.io/
                            def parts = image.tokenize('/')
                            def imageNameOnly = parts[-2..-1].join('/')
                            localImage = "${env.LOCAL_REGISTRY}/${imageNameOnly}"
                        }
                        // ====================================================================
                        
                        echo "Processing: ${image} -> ${localImage}"
                        sh "docker pull ${image}"
                        sh "docker tag ${image} ${localImage}"
                        sh "docker push ${localImage}"
                    }
                }
            }
        }
        stage('Setup Kind, Istio Core, and Addons') {
            steps {
                script {
                    echo "--- Running the main setup script to create the cluster and install Istio ---"
                    withEnv(["PATH+EXTRA=${env.ISTIO_BIN_DIR}"]) {
                        sh "chmod +x ./kind-deployment/setup-kind.sh"
                        sh "./kind-deployment/setup-kind.sh"
                    }
                }
            }
        }
        stage('Deploy Infrastructure Services') {
            steps {
                script {
                    echo "--- Ensuring namespace '${env.APP_NAMESPACE}' exists ---"
                    sh "kubectl create namespace ${env.APP_NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -"
                    echo "--- Applying ALL infrastructure manifests ---"
                    sh "kubectl apply -f ${env.INFRA_MANIFEST_FILE} -n ${env.APP_NAMESPACE}"
                    echo "--- Waiting for infrastructure to become available ---"
                    sh "kubectl wait --for=condition=Available deployment -l component=zookeeper -n ${env.APP_NAMESPACE} --timeout=5m"
                    sh "kubectl wait --for=condition=Available deployment -l component=kafka -n ${env.APP_NAMESPACE} --timeout=5m"
                    sh "kubectl wait --for=condition=Available deployment -l component=elasticsearch -n ${env.APP_NAMESPACE} --timeout=15m"
                    sh "kubectl wait --for=condition=Available deployment -l component=redis -n ${env.APP_NAMESPACE} --timeout=5m"
                    sh "kubectl wait --for=condition=Available deployment -l component=database -n ${env.APP_NAMESPACE} --timeout=10m"
                }
            }
        }
    }
    post {
        success { echo "--- INFRASTRUCTURE DEPLOYMENT SUCCEEDED ---" }
        failure { echo "--- INFRASTRUCTURE DEPLOYMENT FAILED ---" }
    }
}
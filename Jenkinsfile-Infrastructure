// Jenkinsfile-Infrastructure (Conditional pre-pull)
pipeline {
    agent { label 'wsl' }

    environment {
        REGISTRY_HOST         = 'localhost:5000'
        APP_NAMESPACE         = 'lirmm-services'
        INFRA_MANIFEST_FILE   = './kind-deployment/infra-manifests.yaml'
        KIND_CLUSTER_NAME     = "lirmm-dev-cluster"
        KIND_CONFIG_FILE      = "./kind-deployment/kind-cluster-config.yaml"
        KIND_SETUP_SCRIPT     = "./kind-deployment/setup-kind.sh"
        ISTIO_BIN_DIR         = '/home/samir/istio-1.26.3/bin'
        INFRA_IMAGES = """
            confluentinc/cp-zookeeper:7.3.2
            confluentinc/cp-kafka:7.3.2
            docker.elastic.co/elasticsearch/elasticsearch:8.11.1
            redis:7.2-alpine
            postgres:15-alpine
        """
    }

    parameters {
        choice(name: 'MODE', choices: ['BOOTSTRAP', 'RESET_DATA_ONLY'], description: 'BOOTSTRAP: Creates cluster+Istio+addons & infra. RESET_DATA_ONLY: Fast data wipe.')
        booleanParam(name: 'FORCE_PULL_IMAGES', defaultValue: false, description: 'Force pull images even if they exist in local registry')
    }

    stages {
        stage('Bootstrap Cluster and Infrastructure') {
            when { expression { params.MODE == 'BOOTSTRAP' } }
            steps {
                script {
                    echo "--- BOOTSTRAP MODE ---"

                    // Smart image handling: only pull if not in local registry or forced
                    def images = INFRA_IMAGES.trim().split('\\s+')
                    images.each { imageName ->
                        def localImageName = "${REGISTRY_HOST}/${imageName}"
                        
                        // Check if image exists in local registry
                        def imageExists = sh(
                            script: "curl -s http://${REGISTRY_HOST}/v2/${imageName}/tags/list | grep -q '\"tags\"'",
                            returnStatus: true
                        ) == 0
                        
                        if (!imageExists || params.FORCE_PULL_IMAGES) {
                            if (params.FORCE_PULL_IMAGES) {
                                echo "Force pulling image: ${imageName} (FORCE_PULL_IMAGES=true)"
                            } else {
                                echo "Image not found in local registry, pulling: ${imageName}"
                            }
                            sh """
                                docker pull ${imageName}
                                docker tag ${imageName} ${localImageName}
                                docker push ${localImageName}
                            """
                        } else {
                            echo "Image already exists in local registry, skipping pull: ${imageName}"
                        }
                    }

                    // The setup script is now the single source of truth for cluster creation and Istio install.
                    withEnv(["PATH+ISTIO=${env.ISTIO_BIN_DIR}"]) {
                        echo "Running setup script to ensure cluster and Istio are installed..."
                        sh "chmod +x ${KIND_SETUP_SCRIPT}"
                        sh "${KIND_SETUP_SCRIPT}"
                    }

                    // This must run *after* the cluster is confirmed to exist.
                    echo "Connecting local registry to Kind network..."
                    sh 'docker network connect "kind" "kind-registry" || echo "Registry already connected, continuing..."'

                    echo "Deploying infrastructure services (Databases, Kafka, Redis, ES)..."
                    sh "kubectl apply -f ${INFRA_MANIFEST_FILE}"

                    echo "Waiting for all infrastructure to be ready..."
                    sh "kubectl wait --for=condition=available deployment -n ${APP_NAMESPACE} --all --timeout=15m"
                }
            }
        }

        stage('Reset Data Only (Fast)') {
            when { expression { params.MODE == 'RESET_DATA_ONLY' } }
            steps {
                script {
                    echo "--- RESET DATA ONLY MODE ---"
                    echo "Deleting all stateful service pods to wipe data (this is fast)..."
                    // Use labels for efficient deletion
                    sh "kubectl delete pods -n ${APP_NAMESPACE} -l 'component in (zookeeper, kafka, elasticsearch, redis, database)' --ignore-not-found=true"

                    echo "Waiting for infrastructure to come back online..."
                    sh "kubectl wait --for=condition=available deployment -n ${APP_NAMESPACE} --all --timeout=10m"

                    echo "--- Restarting application services to re-run migrations on fresh databases ---"
                    sh "kubectl rollout restart deployment -n ${APP_NAMESPACE} -l app-type=microservice"

                    echo "--- Waiting for application services to become available ---"
                    sh "kubectl wait --for=condition=Available deployment -n ${APP_NAMESPACE} -l app-type=microservice --timeout=15m"
                }
            }
        }
    }

    post {
        success {
            echo "INFRA PIPELINE SUCCEEDED. The system is ready for the application pipeline."
        }
        failure {
            error "INFRA PIPELINE FAILED."
        }
    }
}
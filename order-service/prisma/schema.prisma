// order-service/prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
model Product {
  id       String  @id
  name     String
  sku      String
  imageUrl String?
  @@map("denormalized_products")
}
model DenormalizedUser {
  id           String  @id
  name         String
  profileImage String?
  email        String

  orders Order[]

  @@map("denormalized_users")
}
enum OrderStatus {
  PENDING
  PAID
  FAILED
  SHIPPED
  DELIVERED
  CANCELLED
}

enum ReturnRequestStatus {
  PENDING_APPROVAL
  AWAITING_CUSTOMER_RESPONSE // <-- NEW STATUS
  APPROVED
  REJECTED
  SHIPPED_BY_CUSTOMER
  RECEIVED
  COMPLETED
  CANCELLED
}

enum PaymentMethod {
  CREDIT_CARD
  CASH_ON_DELIVERY
}
model Order {
  id              String        @id @default(uuid())
  userId          String?
  guestEmail      String?
  guestName       String?
  phone           String?
  status          OrderStatus   @default(PENDING)
  paymentMethod   PaymentMethod
  totalAmount     Decimal       @db.Decimal(10, 2)
  shippingAddress Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  paymentTransactionId String?       @unique
  paymentFailureReason String?

  guest_token     String?       @unique // <-- RENAMED

  items           OrderItem[]
  user            DenormalizedUser? @relation(fields: [userId], references: [id])
  returnRequests  ReturnRequest[]

  @@index([userId])
  @@index([guestEmail])
  @@index([phone])
}
model OrderItem {
  id                 String  @id @default(uuid())
  orderId            String
  productId          String
  variantId          String
  productName        String
  variantAttributes  Json
  sku                String
  imageUrl           String?
  priceAtTimeOfOrder Decimal @db.Decimal(10, 2)
  costPriceAtTimeOfOrder Decimal? @db.Decimal(10, 2)
  quantity           Int
  order              Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  returnRequestItems ReturnRequestItem[]

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
}

model ReturnRequest {
  id            String              @id @default(uuid())
  orderId       String
  reason        String
  status        ReturnRequestStatus @default(PENDING_APPROVAL)
  adminComments String?
  imageUrls     Json?               // <-- NEW FIELD FOR IMAGES
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  order         Order               @relation(fields: [orderId], references: [id], onDelete: Cascade)
  items         ReturnRequestItem[]
  comments      ReturnRequestComment[] // <-- NEW RELATION FOR COMMENTS

  @@index([orderId])
}

model ReturnRequestItem {
  id              String  @id @default(uuid())
  returnRequestId String
  orderItemId     String
  quantity        Int

  returnRequest   ReturnRequest @relation(fields: [returnRequestId], references: [id], onDelete: Cascade)
  orderItem       OrderItem     @relation(fields: [orderItemId], references: [id], onDelete: Restrict)

  @@unique([returnRequestId, orderItemId])
  @@index([orderItemId])
}

// --- NEW MODEL: ReturnRequestComment ---
model ReturnRequestComment {
  id              String        @id @default(uuid())
  returnRequestId String
  authorId        String? // Null for guests
  authorName      String    // "Guest" or Admin's name
  commentText     String
  createdAt       DateTime      @default(now())

  returnRequest   ReturnRequest @relation(fields: [returnRequestId], references: [id], onDelete: Cascade)

  @@index([returnRequestId])
}
// --- END NEW MODEL ---